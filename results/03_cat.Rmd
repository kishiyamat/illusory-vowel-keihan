---
title: "Categorize and Rate"
output: github_document
---

- 概要: https://docs.google.com/document/d/1rk5MHMvD5-6SWT7H2nkc-r7v3KvH-dzt_OdftNrDe-I/edit?usp=sharing
- 作業説明: https://docs.google.com/document/d/1U3FCDh8NETS-9mWDLfTU_0mZx9jJpFgkisukI58nV64/edit?usp=sharing

行う分析

- 東京方言話者と近畿方言話者で無声化した音声に対する許容度は異なるのか
  - 音声の尤度自体は低いはず。P(音声|音素)
    - P(音素|音声) も低くなってほしい。
  - なにかおもしろいことが言えないか

> 音がどの表記（ひらがな）に当てはまり(8候補)、
> choices: ['えすぽ', 'えずぼ', 'えくと', 'えぐど', 'えぷそ', 'えぶぞ', 'えつこ', 'えづご'],
> どの程度一致しているかを1--7段階で評価
> questions: [{ prompt: "聞いた音声は選んだ表記として適切ですか？<br>1: 全く適切でない<br>7: 極めて適切", labels: scale }],

- カテゴライズとしての良し悪し

```{r}
library(dplyr)
library(ggplot2)
library(readr)
library(stringr)
library(tidyr)
source("script/subject_info.R")
source("script/results_pitch.R") # load mutated data
```

1. catのタスクを見る
  1. 想定されたものを選んでもらえたか
  1. 想定されたものとしての評価は低すぎないか
  1. sp とかがナチュラルかも気になる（近畿ではないので）

```{r}
# epuso-1.wavなどのaudio列を.で分割し、最初の要素を phoneme, speaker とする
item_list <- read_csv("../src/list/cat_list.csv") %>%
  rowwise() %>%
  mutate(
    wav_base = str_split(audio, "\\.")[[1]][1],
    phoneme = str_split(wav_base, "-")[[1]][1],
    speaker = str_split(wav_base, "-")[[1]][2]
  )

# 被験者情報
subject_info_sone <- read_csv("csv/illusory-vowel-keihan.csv") %>%
  extract_columns(data_src = "sone")
subject_info_cw <- read_csv("csv/illusory-vowel-keihan-cw.csv") %>%
  extract_columns(data_src = "cw")
subject_info <- rbind(subject_info_sone, subject_info_cw) %>%
  mutate(tokyo_kinki_ratio = (span_tokyo - span_kinki) / age)

# cwデータと曽根さんデータのマージ
results_bound <- rbind(
  read_csv("csv/illusory-vowel-keihan.csv") %>% mutate(data_src = "sone"),
  read_csv("csv/illusory-vowel-keihan-cw.csv") %>% mutate(data_src = "cw")
)
```

1. catでの選択を特定
1. rateの抜き出し
1. catのDFの横につける
1. 

```{r}
# catでの選択を特定する(indexは1始まりなので+1する)
results_cat <- results_bound %>% filter(task == "cat")
selected_idx <- results_cat %>%
  select(response) %>%
  unlist() %>%
  as.integer()
# choices = c('えすぽ', 'えずぼ', 'えくと', 'えぐど', 'えぷそ', 'えぶぞ', 'えつこ', 'えづご')
choices <- c("esupo", "ezubo", "ekuto", "egudo", "epuso", "ebuzo", "etsuko", "edzugo")
results_cat$choice <- choices[selected_idx + 1]

# rate同数行を抜き出して横につける。
results_rate <- results_bound %>%
  filter(task == "rate") %>%
  mutate(rate = extract_numeric(response)) %>%
  select(c(rate)) %>%
  unlist()
results_cat$rate <- results_rate

# 被験者情報とアイテム情報のマージ
results <- results_cat %>%
  left_join(subject_info, by = c("run_id", "data_src")) %>%
  filter(type == "target") %>% 
  select(c(subj_id, item_id, tokyo_kinki_ratio, age, choice, rate)) %>%
  drop_na() %>%
  filter(age > 18) %>%
  merge(item_list, on = "item_id")

results
```



```{r}
results %>% ggplot() +
  facet_grid(choice ~ phoneme) +
  geom_histogram(aes(x = rate), stat = "count")
```
etsko はかなり適切。egudoもよい。egdoは低い。
とくにcat課題で許容度に関しての差はなさそう。

```{r}
results %>% ggplot() +
  facet_grid(choice ~ phoneme) +
  # geom_boxplot(aes(
  geom_violin(aes(
    x = factor(range01(tokyo_kinki_ratio), 4),
    y = rate
  ))
```
```{r}
# rateを可視化
results %>%
  group_by(phoneme) %>%
  summarise(rate = mean(rate)) %>%
  print()

# speaker によってひどい差はない
results %>% ggplot() +
  facet_grid(phoneme ~ speaker) +
  geom_histogram(aes(x = rate), stat = "count")
```

非無声化環境で無声化、あるいは無声化環境で無声化していなければスコアは
低くなっていてほしい。

```{r}
results %>%
  rowwise() %>%
  mutate(
    voiced = str_detect(phoneme, "u"),
    no_dev_env = str_detect(phoneme, "[dzbg]"),
    pair = case_when(
      phoneme %in% c("espo", "esupo", "ezbo", "ezubo") ~ "s-p",
      phoneme %in% c("etsko", "etsuko", "edzgo", "edzugo") ~ "ts-k",
      phoneme %in% c("epso", "epuso", "ebzo", "ebuzo") ~ "p-s",
      phoneme %in% c("ekto", "ekuto", "egdo", "egudo") ~ "k-t",
    )
  ) %>%
  ggplot() +
  facet_grid(pair ~ voiced) +
  geom_violin(aes(
    x = factor(range01(tokyo_kinki_ratio), 4),
    y = rate,
    color = no_dev_env
  ))
```

no_dev_envがTなのは非無声化（赤）で、Fは無声化（青; ekto）。
青で母音がある（右列）はおかしい。

いや、しかし質が悪かったとして、問題になるのは有声性の効果のみ。

```{r}
print("EOF")
```
