---
title: "Pitch Delta"
output: html_notebook
---

- 概要: https://docs.google.com/document/d/1rk5MHMvD5-6SWT7H2nkc-r7v3KvH-dzt_OdftNrDe-I/edit?usp=sharing
- 作業説明: https://docs.google.com/document/d/1U3FCDh8NETS-9mWDLfTU_0mZx9jJpFgkisukI58nV64/edit?usp=sharing

行う分析(可視化, 統計)

- 独立変数
  - 被験者要因(居住歴|無声化率)
    - 居住歴: span_kinki, span_kinki_span_other, span_kinki_span_tokyo(閾値が面倒)
    - 無声化率: devoicing_by_subj
  - アイテム要因(東京|アクセントタイプ: ただしアイテムの効果かもしれない)
    - 地域ごと: HLL+LHH OR HHL+LLH
    - アクセントタイプごと: HLL OR LHH OR HHL OR LLH
      (分析が難しい. 差の差の分析にする)
- 従属変数(メインの結果をわかりやすく)
  - 正答率の差 (HHL-HLL, LLH-LHH): わかりづらいな。
    - <- 東京アクセントへの選好性/錯覚のしやすさ ((-HLL) - (-HHL)) 
  - 正答率(錯覚しないか)
  - 反応時間の差

方針

1. 全てのカラムをDFに落とし込む
1. formula で可視化と分析を実施

TODO 

- [x] アクセントパターンでの分析
- [x] 被験者ごとに差を見る(HHL-HLLのスコア、など)
  - 東京バイアス、とする。
- [x] `正答率~近畿` (Xは2パターンある。formulaかなにかで回す方がよい)
  - 「正答率」は aとbのどちらに寄せるか。
    - 平均で(前と後ろの選好性を平均する)
    -掛け算
- [ ] 外れ値の除外 (正答率、反応時間)
  - 正答率に関しては適当に受けるとチャンスレベルになるので問題
  - 分析対象を変えていくよりは、行う分析を決めて一気に進めたほうがよい　

### データ整形

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(readr)
library(stringr)
library(tidyr)
source("script/subject_info.R")
source("script/geom_flat_violin.R")
source("script/results_pitch.R")  # load mutated data

# 東京バイアスを計算(統計用)
results_by_subject <- results_pitch %>%
  select(c(phoneme, pitch_to, run_id, data_src, is_correct)) %>%
  group_by(phoneme, pitch_to, run_id, data_src) %>%
  # phoneme, pitch_to, 被験者ごとに、正答率を平均する(axbのaとbをまとめる)
  mutate(is_correct_mean = mean(is_correct)) %>%
  ungroup() %>%
  select(-c(is_correct)) %>%
  distinct() %>%
  # 被験者ごとにピッチ間(HLL--HHL)で差を見てバイアスの値とする
  mutate(phoneme_pitch_to = paste0(phoneme, pitch_to)) %>%
  select(-c(phoneme, pitch_to)) %>%
  pivot_wider(names_from = phoneme_pitch_to, values_from = is_correct_mean) %>%
  mutate( # 東京バイアスの計算. 分かりづらいので良く説明. 音素とピッチは列名に含ませる
    etsto_H_L_tokyo_bias = `etsto-HHL` - `etsto-HLL`,
    esko_H_L_tokyo_bias = `esko-HHL` - `esko-HLL`,
    etsto_L_H_tokyo_bias = `etsto-LLH` - `etsto-LHH`,
    esko_L_H_tokyo_bias = `esko-LLH` - `esko-LHH`
  ) %>%
  select(c(
    run_id, data_src,
    etsto_H_L_tokyo_bias, esko_H_L_tokyo_bias, etsto_L_H_tokyo_bias, esko_L_H_tokyo_bias
  )) %>%
  pivot_longer(
    cols = c(etsto_H_L_tokyo_bias, esko_H_L_tokyo_bias, etsto_L_H_tokyo_bias, esko_L_H_tokyo_bias),
    names_to = "item",
    values_to = "to_tokyo_pattern"
  ) %>%
  # 音素やH_Lの情報を復元
  mutate(
    phoneme = case_when(
      grepl("etsto", item, fixed = TRUE) ~ "etsto",
      grepl("esko", item, fixed = TRUE) ~ "esko"
    ),
    pitch_from = case_when(
      grepl("H_L", item, fixed = TRUE) ~ "From H_L",
      grepl("L_H", item, fixed = TRUE) ~ "From L_H"
    )
  ) %>%
  left_join(devoicing_annotation_subj, by = c("run_id", "data_src"))

head(results_by_subject)
```

### 可視化

1. 基本情報(results_pitch): 被験者間実験なので分散が大きい(Appendix行き)
  * 条件ごとの精度
  * 被験者ごとの精度
  * アイテムごとの精度
1. 統計(results_by_subject)
* 


```{r}
# H_L だと分布がちょっと下におちて、tokyo_pref, つまりXが少なくなっている。
results_by_subject %>% 
  group_by(phoneme, pitch_from, subj_id) %>% 
  ggplot() +
  facet_grid(.~pitch_from) +
  geom_violin(aes(x=as.factor(floor(devoiced/0.1)), y=to_tokyo_pattern))
```

```{r}
results_by_subject %>% 
  group_by(phoneme, pitch_from, subj_id) %>% 
  ggplot() +
  facet_grid(phoneme~pitch_from) +
  geom_flat_violin(aes(x=as.factor(floor(span_tokyo_span_kinki/age/0.5)), y=to_tokyo_pattern))
```
```{r}
results_by_subject %>% 
  ggplot() +
  facet_grid(phoneme~pitch_from) +
  # geom_violin(aes(x=as.factor(floor(span_tokyo/age/0.1)), y=to_tokyo_pattern))
  geom_violin(aes(x=as.factor(floor(span_tokyo_span_kinki/age/0.5)), y=to_tokyo_pattern)) 
```

### 統計分析

```{r}
# 年齢で標準化すると効果がでるのか...ちょっと行儀わるいけど
# summary(lm(to_tokyo_pattern~scale(span_tokyo/age)+pitch_from, results_by_subject))
library(lme4)
library(lmerTest)
formula_list <- c(
  to_tokyo_pattern ~ scale(span_tokyo / age) + pitch_from,
  to_tokyo_pattern ~ scale(span_tokyo / age) + pitch_from
)

summary(lmer(to_tokyo_pattern ~ scale(span_tokyo / age) + pitch_from + (1 | subj_id) + (1 | phoneme), results_by_subject))
# results_by_subject
# summary(lm(to_tokyo_pattern~scale(span_tokyo_span_other/age)+pitch_from, results_by_subject))
```

```{r}
# 基本的に、つねにHHLの時に気づけている
# 対して、LHHでもLLHでもそんなに変わらなさそう
# 東京バイアスなら引き算でよくね？
# aとbでは大きな差があるが
# 一応、異なる話者では分けてあるこれで十分計算はできるはず。
results_pitch %>% 
  group_by(phoneme, pitch_to, subj_id, correct) %>% 
  mutate(is_correct_mean = mean(is_correct)) %>% 
  pivot_wider()
  ggplot() +
  facet_grid(phoneme+correct~pitch_to) +
  # geom_point(aes(x=scale(voiced), y=is_correct_mean, color=pitch_x)) +
```


```{r}
results_mean <- results_pitch %>%
  group_by(subj_id, pitch) %>%
  mutate(
    correct_mean = mean(as.logical(is_correct)) # ,
    # rt_mean = mean(as.numeric(rt))
  ) %>%
  select(-c(is_correct, rt, trial_index, item_id, correct)) %>%
  ungroup() %>%
  distinct()
results_mean %>% head()
```

```{r}
# 横持ちにして HLL-HHL などを計算
results_mean %>%
  select(-c(pitch_a, pitch_b, type, is_tokyo)) %>%
  filter(tone %in% c("-HLL", "-LHH", "-HHL", "-LLH")) %>%
  pivot_wider(names_from = tone, values_from = correct_mean, values_fn = mean) %>%
  mutate(
    tokyo_pref_HLL = `-HLL` - `-HHL`,
    tokyo_pref_LLH = `-LHH` - `-LLH`,
    span_kinki_span_tokyo_age = span_kinki_span_tokyo / age
  ) %>%
  # lm(formula=tokyo_pref_HLL~ span_kinki_span_tokyo_age) %>% summary
  # lm(formula=tokyo_pref_HLL~ devoiced) %>% summary
  # lm(formula=tokyo_pref_LLH~ devoiced) %>% summary
  ggplot() +
  # geom_point(aes(y = tokyo_pref_LHH, x = devoiced))
  # geom_point(aes(y = tokyo_pref_HLL, x = span_tokyo_span_kinki))
  geom_point(aes(y = tokyo_pref_HLL, x = devoiced)) # span_tokyoとかと比べると傾くんだなぁ
# geom_point(aes(y = tokyo_pref_HLL, x = devoiced))  # span_tokyoとかと比べると傾くんだなぁ
```

```{r}
results_mean %>%
  filter(tone %in% c("-HLL", "-LHH", "-HHL", "-LLH")) %>%
  filter(rt_mean < 2000) %>%
  ggplot() +
  facet_grid(. ~ tone) +
  geom_point(aes(y = correct_mean, x = devoiced))
# summary(lm(correct_mean ~ devoiced*is_tokyo+correct, results_mean))
```

```{r}
results_mean %>% ggplot() +
  facet_wrap(. ~ correct) +
  geom_point(aes(y = correct_mean, x = span_tokyo_span_kinki))

summary(lm(correct_mean ~ span_tokyo_span_kinki, results_mean))
```


```{r}
results_pitch %>%
  mutate(tokyo_exp = case_when(
    span_tokyo_span_kinki >= 0 ~ "Tokyo",
    span_tokyo_span_kinki < 0 ~ "Kinki"
  )) %>%
  ggplot() +
  facet_wrap(tokyo_exp ~ correct) +
  geom_histogram(aes(x = is_tokyo, color = is_correct, fill = is_correct), stat = "count", position = "fill")
```
```{r}
order <- "b"
results_pitch %>%
  filter(correct == order) %>%
  mutate(tokyo_exp = case_when(
    span_kinki_span_tokyo >= 0 ~ "Kinki",
    span_kinki_span_tokyo < 0 ~ "Tokyo"
  )) %>%
  ggplot() +
  facet_wrap(tokyo_exp ~ subj_id) +
  geom_histogram(aes(x = is_tokyo, color = is_correct, fill = is_correct), stat = "count", position = "fill")
ggsave(paste0("artifact/test_", order, ".png"), unit = "cm", width = 20, height = 20)
```

```{r}
tgt <- c("-HHL", "-HLL", "-LHH", "-LLH") # HLは近畿にもある。東京とは言えない。
# tgt  = c("-HHL","-HLL")  # HLは近畿にもある。東京とは言えない。

order <- "a"
th <- -20
results_pitch %>%
  filter(correct == order) %>%
  mutate(tokyo_exp = case_when(
    span_tokyo_span_kinki >= th ~ "Tokyo",
    span_tokyo_span_kinki < th ~ "Kinki"
  )) %>%
  filter(tone %in% tgt) %>%
  ggplot() +
  facet_wrap(tokyo_exp ~ subj_id) +
  # facet_wrap(tokyo_exp~correct) +
  geom_histogram(aes(x = tone, color = is_correct, fill = is_correct), stat = "count", position = "fill") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  # ggtitle("Accuracy by Tone and Region") +
  xlab("Tone Type") +
  ylab("Accuracy") +
  theme(legend.position = "none")

ggsave(paste0("artifact/correct_", order, "_", th, ".png"), unit = "cm", width = 20, height = 20)
```


```{r}
print("EOF")
```
