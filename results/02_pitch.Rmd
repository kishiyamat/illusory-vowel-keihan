---
title: "Pitch"
output: html_notebook
---

- 概要: https://docs.google.com/document/d/1rk5MHMvD5-6SWT7H2nkc-r7v3KvH-dzt_OdftNrDe-I/edit?usp=sharing
- 作業説明: https://docs.google.com/document/d/1U3FCDh8NETS-9mWDLfTU_0mZx9jJpFgkisukI58nV64/edit?usp=sharing

行う分析(可視化, 統計)

- 独立変数
  - 被験者要因(居住歴|無声化率)
    - 居住歴: span_kinki, span_kinki_span_other, span_kinki_span_tokyo(閾値が面倒)
    - 無声化率: devoicing_by_subj
  - アイテム要因(東京|アクセントタイプ)
    - 地域ごと: HLL+LHH OR HHL+LLH
    - アクセントタイプごと: HLL OR LHH OR HHL OR LLH
      (分析が難しい. 差の差の分析にする)
- 従属変数
  - 正答率の差
  - 反応時間の差

方針

1. 全てのカラムをDFに落とし込む
1. formula で可視化と分析を実施

TODO 

- [ ] アクセントパターンでの分析
- [ ] `正答率~近畿`
  - 「正答率」は aとbのどちらに寄せるか。
    - 平均で(前と後ろの選好性を平均する)
    -掛け算
- [ ] 被験者ごとに差を見る(HHL-HLLのスコア、など)
- [ ] 外れ値の除外(正答率、反応時間)
- 分析対象を変えていくよりは、行う分析を決めて一気に進めたほうがよい　

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(readr)
library(stringr)
library(tidyr)
source("script/subject_info.R")

item_list <- read_csv("../src/list/axb_list.csv") %>% select(c(item_id, type, correct, item_a, item_x, item_b, pitch_a, pitch_x, pitch_b))
# read_csv("../src/list/axb_list.csv") %>% head
devoice_list <- read_csv("devoicing_by_subj.csv") # アノテーションデータ

tone_sone <- read_csv("csv/illusory-vowel-keihan.csv") %>%
  filter(task == "axb") %>%
  select(c(run_id, item_id, is_correct, rt, trial_index)) %>%
  mutate(data_src = "sone")

tone_cw <- read_csv("csv/illusory-vowel-keihan-cw.csv") %>%
  filter(task == "axb") %>%
  select(c(run_id, item_id, is_correct, rt, trial_index)) %>%
  mutate(data_src = "cw")

results <- rbind(tone_sone, tone_cw) %>%
  left_join(devoice_list, by = c("run_id", "data_src")) %>%
  merge(item_list, on = "item_id") %>%
  filter(type != "target") %>%
  mutate(
    pitch_to = case_when(
      correct == "a" ~ pitch_b, # 反対が母音あり版
      correct == "b" ~ pitch_a
    ),
    pitch_from = case_when(
      correct == "a" ~ pitch_a, # 反対が母音あり版
      correct == "b" ~ pitch_b
    ),
    phoneme= as.factor(str_sub(item_x, 1, -nchar(pitch_x)-1))
  ) %>%
  mutate(pitch_type = case_when(
    pitch_to %in% c("-HL", "-HLL", "-LHH") ~ "Tokyo",
    pitch_to %in% c("-LL", "-HHL", "-LLH") ~ "Kinki"
  )) %>%
  filter(pitch_to %in%  c("-HLL", "-LHH", "-HHL", "-LLH")) %>% 
  drop_na() %>% 
  mutate(is_correct=as.logical(is_correct),
         rt=as.numeric(rt), 
         voiced=as.numeric(voiced))

summary(results)
results
```
```{r}
# 基本的に真ん中が足りないもの。
head(results, 1000)
```
```{r}
# TODO: etsuto-HLL - etsuto-HHL を見る(東京バイアス)
# ただし、a--b や 音素の情報は潰したくない
# Yを計算
results_by_subject <- results %>%
  select(c(phoneme, pitch_to, run_id, data_src, is_correct)) %>%
  group_by(phoneme, pitch_to, run_id, data_src) %>%
  mutate(is_correct_mean = mean(is_correct)) %>%
  ungroup() %>%
  select(-c(is_correct)) %>%
  distinct() %>%
  mutate(phoneme_pitch_to = paste0(phoneme, pitch_to)) %>%
  select(-c(phoneme, pitch_to)) %>%
  pivot_wider(names_from = phoneme_pitch_to, values_from = is_correct_mean) %>%
  # TODO: ここの値を保証する
  mutate(
    etsto_H_L_tokyo = `etsto-HLL` - `etsto-HHL`,
    esko_H_L_tokyo = `esko-HLL` - `esko-HHL`,
    etsto_L_H_tokyo = `etsto-LHH` - `etsto-LLH`,
    esko_L_H_tokyo = `esko-LHH` - `esko-LLH`
  ) %>%
  select(c(run_id, data_src, etsto_H_L_tokyo, esko_H_L_tokyo, etsto_L_H_tokyo, esko_L_H_tokyo)) %>%
  pivot_longer(cols = c(etsto_H_L_tokyo, esko_H_L_tokyo, etsto_L_H_tokyo, esko_L_H_tokyo), names_to = "item", values_to = "tokyo_pref") %>%
  mutate(
    phoneme = case_when(
      grepl("etsto", item, fixed=TRUE) ~ "etsto",
      grepl("esko", item, fixed=TRUE) ~ "esko"
    ),
    pitch_from = case_when(
      grepl("H_L", item, fixed=TRUE) ~ "H_L",
      grepl("L_H", item, fixed=TRUE) ~ "L_H"
    )
  ) %>% 
  left_join(devoice_list, by = c("run_id", "data_src"))

results_by_subject
```
```{r}
# H_L だと分布がちょっと下におちて、tokyo_pref, つまりXが少なくなっている。
results_by_subject %>% 
  group_by(phoneme, pitch_from, subj_id) %>% 
  ggplot() +
  facet_grid(.~pitch_from) +
  geom_boxplot(aes(x=as.factor(floor(scale(voiced))), y=tokyo_pref))
  # geom_violin(aes(x=as.factor(floor(scale(voiced))), y=tokyo_pref))

# results_by_subject %>% 
#   group_by(phoneme, pitch_from, subj_id) %>% 
#   ggplot() +
#   facet_grid(phoneme~pitch_from) +
#   # geom_boxplot(aes(x=as.factor(floor(scale(span_tokyo))), y=tokyo_pref))
#   geom_violin(aes(x=as.factor(floor(scale(span_kinki_span_tokyo))), y=tokyo_pref))
```

```{r}
# 基本的に、つねにHHLの時に気づけている
# 対して、LHHでもLLHでもそんなに変わらなさそう
# 東京バイアスなら引き算でよくね？
# aとbでは大きな差があるが
# 一応、異なる話者では分けてあるこれで十分計算はできるはず。
results %>% 
  group_by(phoneme, pitch_to, subj_id, correct) %>% 
  mutate(is_correct_mean = mean(is_correct)) %>% 
  pivot_wider()
  ggplot() +
  facet_grid(phoneme+correct~pitch_to) +
  # geom_point(aes(x=scale(voiced), y=is_correct_mean, color=pitch_x)) +
```


```{r}
results_mean <- results %>%
  group_by(subj_id, pitch) %>%
  mutate(
    correct_mean = mean(as.logical(is_correct)) # ,
    # rt_mean = mean(as.numeric(rt))
  ) %>%
  select(-c(is_correct, rt, trial_index, item_id, correct)) %>%
  ungroup() %>%
  distinct()
results_mean %>% head()
```
```{r}
# 横持ちにして HLL-HHL などを計算
results_mean %>%
  select(-c(pitch_a, pitch_b, type, is_tokyo)) %>%
  filter(tone %in% c("-HLL", "-LHH", "-HHL", "-LLH")) %>%
  pivot_wider(names_from = tone, values_from = correct_mean, values_fn = mean) %>%
  mutate(
    tokyo_pref_HLL = `-HLL` - `-HHL`,
    tokyo_pref_LLH = `-LHH` - `-LLH`,
    span_kinki_span_tokyo_age = span_kinki_span_tokyo / age
  ) %>%
  # lm(formula=tokyo_pref_HLL~ span_kinki_span_tokyo_age) %>% summary
  # lm(formula=tokyo_pref_HLL~ devoiced) %>% summary
  # lm(formula=tokyo_pref_LLH~ devoiced) %>% summary
  ggplot() +
  # geom_point(aes(y = tokyo_pref_LHH, x = devoiced))
  # geom_point(aes(y = tokyo_pref_HLL, x = span_tokyo_span_kinki))
  geom_point(aes(y = tokyo_pref_HLL, x = devoiced)) # span_tokyoとかと比べると傾くんだなぁ
# geom_point(aes(y = tokyo_pref_HLL, x = devoiced))  # span_tokyoとかと比べると傾くんだなぁ
```

```{r}
results_mean %>%
  filter(tone %in% c("-HLL", "-LHH", "-HHL", "-LLH")) %>%
  filter(rt_mean < 2000) %>%
  ggplot() +
  facet_grid(. ~ tone) +
  geom_point(aes(y = correct_mean, x = devoiced))
# summary(lm(correct_mean ~ devoiced*is_tokyo+correct, results_mean))
```

```{r}
results_mean %>% ggplot() +
  facet_wrap(. ~ correct) +
  geom_point(aes(y = correct_mean, x = span_tokyo_span_kinki))

summary(lm(correct_mean ~ span_tokyo_span_kinki, results_mean))
```


```{r}
results %>%
  mutate(tokyo_exp = case_when(
    span_tokyo_span_kinki >= 0 ~ "Tokyo",
    span_tokyo_span_kinki < 0 ~ "Kinki"
  )) %>%
  ggplot() +
  facet_wrap(tokyo_exp ~ correct) +
  geom_histogram(aes(x = is_tokyo, color = is_correct, fill = is_correct), stat = "count", position = "fill")
```
```{r}
order <- "b"
results %>%
  filter(correct == order) %>%
  mutate(tokyo_exp = case_when(
    span_kinki_span_tokyo >= 0 ~ "Kinki",
    span_kinki_span_tokyo < 0 ~ "Tokyo"
  )) %>%
  ggplot() +
  facet_wrap(tokyo_exp ~ subj_id) +
  geom_histogram(aes(x = is_tokyo, color = is_correct, fill = is_correct), stat = "count", position = "fill")
ggsave(paste0("artifact/test_", order, ".png"), unit = "cm", width = 20, height = 20)
```

```{r}
tgt <- c("-HHL", "-HLL", "-LHH", "-LLH") # HLは近畿にもある。東京とは言えない。
# tgt  = c("-HHL","-HLL")  # HLは近畿にもある。東京とは言えない。

order <- "a"
th <- -20
results %>%
  filter(correct == order) %>%
  mutate(tokyo_exp = case_when(
    span_tokyo_span_kinki >= th ~ "Tokyo",
    span_tokyo_span_kinki < th ~ "Kinki"
  )) %>%
  filter(tone %in% tgt) %>%
  ggplot() +
  facet_wrap(tokyo_exp ~ subj_id) +
  # facet_wrap(tokyo_exp~correct) +
  geom_histogram(aes(x = tone, color = is_correct, fill = is_correct), stat = "count", position = "fill") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  # ggtitle("Accuracy by Tone and Region") +
  xlab("Tone Type") +
  ylab("Accuracy") +
  theme(legend.position = "none")

ggsave(paste0("artifact/correct_", order, "_", th, ".png"), unit = "cm", width = 20, height = 20)
```


```{r}
print("EOF")
```
